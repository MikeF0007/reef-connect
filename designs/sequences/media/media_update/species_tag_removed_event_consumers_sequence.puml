@startuml SpeciesTagRemoved Event Consumers Sequence
queue "Event Bus" as Events
participant "Materialized Data Worker" as MaterializedDataWorker
participant "API Server" as API
database "Database" as DB

== Parallel consumers of SpeciesTagRemoved event ==
par ScubaDex Update
    Events -> MaterializedDataWorker: consume SpeciesTagRemoved (user_id, species_id, media_id)
    activate MaterializedDataWorker
    MaterializedDataWorker -> DB: DECREMENT times_encountered\nfor scubadex_entries\n(user_id, species_id)
    MaterializedDataWorker -> DB: if times_encountered = 0,\ndelete scubadex_entries row
    MaterializedDataWorker -> Events: publish ScubaDexUpdated\n(user_id, species_id)
    deactivate MaterializedDataWorker
end par

par API Cache Invalidation
    Events -> API: consume SpeciesTagRemoved (media_id, species_id)
    activate API
    API -> API: invalidate media cache (media_id)
    deactivate API
end par
@enduml
